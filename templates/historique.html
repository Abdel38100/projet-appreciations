{% extends "base.html" %}
{% block title %}Historique pour {{ classe.nom_classe }}{% endblock %}
{% block content %}
<h2>Historique des Analyses pour : {{ classe.nom_classe }} ({{ classe.annee_scolaire }})</h2>
<a href="{{ url_for('main.analyser') }}" class="btn btn-secondary mb-3">Retour à l'analyse</a>

{% for nom_eleve, analyses in analyses_par_eleve.items() %}
<div class="card mb-4">
    <div class="card-header bg-dark text-white">
        <h4 class="mb-0">{{ nom_eleve }}</h4>
    </div>
    <div class="card-body">
        {% for analyse in analyses %}
        <div class="border p-3 mb-3 rounded">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="mb-1">Trimestre {{ analyse.trimestre }}</h5>
                    <small class="text-muted">
                        Généré le {{ analyse.created_at.strftime('%d/%m/%Y à %H:%M') }} 
                        avec {{ analyse.provider_name }} (Prompt: {{ analyse.prompt_name }})
                    </small>
                </div>
                <form action="{{ url_for('main.supprimer_analyse', analyse_id=analyse.id) }}" method="POST" onsubmit="return confirm('Voulez-vous vraiment supprimer cette version de l\'appréciation ?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
                </form>
            </div>
            <hr>
            <h6>Appréciation Générale :</h6>
            <p class="card-text bg-light p-2 rounded">{{ analyse.appreciation_principale }}</p>
            <p>
              <a class="btn btn-secondary btn-sm" data-bs-toggle="collapse" href="#justifications-{{ analyse.id }}">Voir/Cacher les justifications</a>
            </p>
            <div class="collapse" id="justifications-{{ analyse.id }}">
              <div class="card card-body">
                {{ analyse.justifications | markdown }}
              </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert alert-info">Aucune analyse n'a encore été sauvegardée pour cette classe.</div>
{% endfor %}
{% endblock %}