{% extends "base.html" %}

{% block title %}Suivi de l'Analyse{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Suivi de l'Analyse en Temps Réel</h1>
    <div id="compteur" class="fs-5"></div>
</div>

<div id="zone-resultats">
    <!-- Les résultats des tâches apparaîtront ici -->
</div>

<!-- 
    On déplace la variable dans le bloc de script, mais en utilisant une technique
    qui est valide pour VS Code et pour le moteur de template de Flask.
-->
<script id="job-data" type="application/json">
    {{ job_ids | tojson }}
</script>

<script>
    // On récupère les données depuis la balise script dédiée
    const jobDataElement = document.getElementById('job-data');
    const jobIds = JSON.parse(jobDataElement.textContent);

    const zoneResultats = document.getElementById('zone-resultats');
    const compteurElement = document.getElementById('compteur');
    let tachesTerminees = 0;

    function majCompteur() {
        compteurElement.innerHTML = `<strong>${tachesTerminees} / ${jobIds.length}</strong> tâches terminées`;
    }

    // Le reste du script est identique
    jobIds.forEach(id => {
        const div = document.createElement('div');
        div.className = 'card mb-3';
        div.id = `job-${id}`;
        div.innerHTML = `
            <div class="card-body d-flex align-items-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Analyse en cours pour la tâche ${id}...</span>
            </div>
        `;
        zoneResultats.appendChild(div);
    });
    majCompteur();

    function verifierStatut() {
        const idsEnCours = jobIds.filter(id => {
            const element = document.getElementById(`job-${id}`);
            return element && !element.classList.contains('termine');
        });

        if (idsEnCours.length === 0) {
            return;
        }

        fetch("{{ url_for('statut_jobs') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_ids: idsEnCours })
        })
        .then(response => response.json())
        .then(data => {
            data.forEach(job => {
                const div = document.getElementById(`job-${job.id}`);
                if (!div || div.classList.contains('termine')) return;

                if (job.status === 'finished' || job.status === 'failed') {
                    div.classList.add('termine');
                    tachesTerminees++;
                    majCompteur();
                    let htmlResultat = '';

                    if (job.status === 'finished' && job.resultat && job.resultat.status === 'succes') {
                        const res = job.resultat;
                        div.innerHTML = `
                            <div class="card-header d-flex justify-content-between align-items-center bg-success text-white">
                                <strong>Analyse terminée pour : ${res.nom_eleve}</strong>
                                <span>Succès</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">Proposition d'Appréciation Globale</h5>
                                <p class="card-text bg-light p-2 rounded">${res.appreciation_principale}</p>
                                <div class="p-2 mt-2 border rounded">
                                    <h6 class="card-subtitle mb-2 text-muted">Justifications</h6>
                                    ${res.justifications}
                                </div>
                            </div>
                        `;
                    } else {
                        div.innerHTML = `
                            <div class="card-header d-flex justify-content-between align-items-center bg-danger text-white">
                                <strong>Échec de l'analyse</strong>
                                <span>Erreur</span>
                            </div>
                            <div class="card-body">
                                ${ (job.resultat && job.resultat.erreur) ? job.resultat.erreur : "Erreur inconnue." }
                            </div>
                        `;
                    }
                }
            });
            setTimeout(verifierStatut, 5000);
        });
    }

    setTimeout(verifierStatut, 1000);
</script>
{% endblock %}