{% extends "base.html" %}

{% block title %}Suivi de l'Analyse{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Suivi de l'Analyse en Temps Réel</h1>
    <div id="compteur" class="fs-5"></div>
</div>

<div id="zone-resultats">
    <!-- Les résultats des tâches apparaîtront ici -->
</div>

<script id="job-data" type="application/json">
    {{ job_ids | tojson }}
</script>

<script>
    const jobDataElement = document.getElementById('job-data');
    const jobIds = JSON.parse(jobDataElement.textContent);
    const zoneResultats = document.getElementById('zone-resultats');
    const compteurElement = document.getElementById('compteur');
    let tachesTerminees = 0;

    function majCompteur() {
        compteurElement.innerHTML = `<strong>${tachesTerminees} / ${jobIds.length}</strong> tâches terminées`;
    }

    jobIds.forEach(id => {
        const div = document.createElement('div');
        div.id = `job-${id}`;
        div.innerHTML = `<div class="card mb-3"><div class="card-body d-flex align-items-center"><div class="spinner-border text-primary me-3" role="status"><span class="visually-hidden">Loading...</span></div><span>Analyse en cours pour la tâche ${id}...</span></div></div>`;
        zoneResultats.appendChild(div);
    });
    majCompteur();

    function verifierStatut() {
        const idsEnCours = jobIds.filter(id => { const element = document.getElementById(`job-${id}`); return element && !element.classList.contains('termine'); });
        if (idsEnCours.length === 0) return;

        fetch("{{ url_for('statut_jobs') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ job_ids: idsEnCours }) })
        .then(response => response.json())
        .then(data => {
            data.forEach(job => {
                const div = document.getElementById(`job-${job.id}`);
                if (!div || div.classList.contains('termine')) return;

                if (job.status === 'finished' || job.status === 'failed') {
                    div.classList.add('termine');
                    tachesTerminees++;
                    majCompteur();

                    if (job.status === 'finished' && job.resultat && job.resultat.status === 'succes') {
                        const res = job.resultat;
                        
                        let tableauHtml = '<table class="table table-sm table-bordered"><thead><tr><th>Matière</th><th>Moyenne</th><th>Appréciation</th></tr></thead><tbody>';
                        if (res.donnees && res.donnees.appreciations_matieres) {
                            res.donnees.appreciations_matieres.forEach(item => {
                                // Échapper le HTML potentiel dans les commentaires pour la sécurité
                                const commentaireEchappe = item.commentaire.replace(/</g, "<").replace(/>/g, ">");
                                tableauHtml += `<tr><td>${item.matiere}</td><td>${item.moyenne}</td><td>${commentaireEchappe}</td></tr>`;
                            });
                        }
                        tableauHtml += '</tbody></table>';

                        div.innerHTML = `
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center bg-success text-white">
                                    <strong>Analyse terminée pour : ${res.nom_eleve}</strong>
                                    <span>Succès</span>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">1. Données Extraites du Bulletin</h5>
                                    ${tableauHtml}
                                    <hr>
                                    <h5 class="card-title mt-4">2. Proposition d'Appréciation Globale</h5>
                                    <textarea rows="4" class="form-control mb-3">${res.appreciation_principale}</textarea>
                                    <div class="p-3 mt-2 border rounded bg-light">
                                        <h6 class="card-subtitle mb-2 text-muted">3. Justifications de l'IA</h6>
                                        <div>${res.justifications_html}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const nomEleve = (job.resultat && job.resultat.nom_eleve) ? job.resultat.nom_eleve : "Élève inconnu";
                        const erreurMsg = (job.resultat && job.resultat.erreur) ? job.resultat.erreur : "Erreur inconnue.";
                        div.innerHTML = `
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center bg-danger text-white">
                                    <strong>Échec de l'analyse pour : ${nomEleve}</strong>
                                    <span>Erreur</span>
                                </div>
                                <div class="card-body">
                                    <p class="text-danger">${erreurMsg}</p>
                                </div>
                            </div>
                        `;
                    }
                }
            });
            if (tachesTerminees < jobIds.length) {
                setTimeout(verifierStatut, 5000);
            }
        });
    }
    setTimeout(verifierStatut, 1000);
</script>
{% endblock %}